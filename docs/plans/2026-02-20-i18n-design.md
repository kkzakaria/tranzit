# Design — Internationalisation (i18n)

**Date :** 2026-02-20
**Statut :** Approuvé

## Contexte

Ajout de l'internationalisation à l'application Tranzit (Next.js 16, App Router). Le projet est au stade initial — une seule page, un layout, des composants UI de base.

## Décisions clés

| Décision | Choix |
|---|---|
| Librairie | `next-intl` |
| Langues supportées | `fr` (défaut), `en`, `ar` (RTL), `zh` (chinois simplifié) |
| Détection de langue | Accept-Language → cookie NEXT_LOCALE → fallback `fr` |
| Routing | Préfixe de locale dans l'URL : `/fr/`, `/en/`, `/ar/`, `/zh/` |
| Structure des messages | Un dossier par locale, un fichier JSON par namespace |

## Architecture

### Structure de fichiers

```
app/
  [locale]/           ← nouveau segment dynamique (remplace app/ direct)
    layout.tsx        ← fournit NextIntlClientProvider + dir RTL + lang
    page.tsx
    demo/
      panel-layout/
middleware.ts         ← détection locale + redirect (racine du projet)
i18n/
  routing.ts          ← définition des locales et defaultLocale
  request.ts          ← configuration next-intl côté serveur (getRequestConfig)
messages/
  fr/
    common.json       ← labels communs (boutons, actions, états)
    navigation.json   ← liens de navigation sidebar
    appbar.json       ← éléments de l'AppBar
  en/
    common.json
    navigation.json
    appbar.json
  ar/
    common.json
    navigation.json
    appbar.json
  zh/
    common.json
    navigation.json
    appbar.json
```

### Middleware

Le middleware intercepte toutes les routes (hors `_next/static`, `_next/image`, `favicon.ico`, fichiers statiques). Il utilise `createNavigation` de next-intl pour :

1. Lire le cookie `NEXT_LOCALE` (choix utilisateur persisté)
2. Négocier la langue via `Accept-Language`
3. Fallback sur `fr`
4. Rediriger `/` → `/fr/` (ou la locale détectée)

### Layout `[locale]`

Le `app/[locale]/layout.tsx` :
- Reçoit `params.locale` depuis les props
- Applique `lang={locale}` et `dir={locale === 'ar' ? 'rtl' : 'ltr'}` sur `<html>`
- Wrap avec `NextIntlClientProvider` pour les traductions côté client
- Valide la locale avec `notFound()` si invalide

### Chargement des messages

`i18n/request.ts` (getRequestConfig) charge dynamiquement les fichiers JSON par namespace et les merge :

```ts
// Charge fr/common.json + fr/navigation.json + fr/appbar.json
// et les merge en un objet plat pour next-intl
const messages = await loadMessages(locale)
```

### Usage dans les composants

**Server Components :**
```ts
const t = await getTranslations('common')
t('search') // → "Rechercher"
```

**Client Components :**
```ts
const t = useTranslations('appbar')
t('notifications') // → "Notifications"
```

### Sélecteur de langue

Composant `LanguageSwitcher` ajouté dans les actions de l'AppBar (à côté de `ThemeToggle`). Il :
- Affiche un menu déroulant (Dropdown) avec les 4 langues
- Utilise le `useRouter` de next-intl pour changer de locale
- Persiste le choix dans le cookie `NEXT_LOCALE`
- Affiche le nom de la langue dans sa propre langue (Français, English, العربية, 中文)

### Support RTL (arabe)

- `dir="rtl"` sur `<html>` quand `locale === 'ar'`
- Les composants existants utilisent des propriétés CSS logiques (Tailwind `ms-`, `me-`, `ps-`, `pe-`) pour que les marges/paddings s'adaptent automatiquement au sens de lecture

## Résumé des dépendances à installer

```bash
bun add next-intl
```

## Hors périmètre

- Traduction complète de tous les textes futurs (seuls les composants existants sont traduits dans ce sprint)
- Détection de timezone par locale
- Formats de date/nombre localisés (géré par next-intl mais non explicitement configuré dans cette phase)
